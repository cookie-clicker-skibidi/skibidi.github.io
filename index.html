<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Match OPR Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .info {
      font-size: 16px;
      color: #bbb;
      margin-bottom: 20px;
    }
    input {
      padding: 10px;
      width: 220px;
      background-color: #1e1e1e;
      border: 1px solid #444;
      color: white;
      border-radius: 5px;
      text-align: center;
    }
    button {
      padding: 10px 15px;
      margin-left: 5px;
      background-color: #6200ee;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3700b3;
    }
    .team-box {
      background-color: #333;
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .warning-box {
      background-color: #f1c40f;
      color: #333;
      padding: 10px;
      margin: 15px 0;
      border-radius: 5px;
      font-size: 16px;
    }
    .prediction-box {
      background-color: #555;
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .rounded {
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Enter Event Code</h1>
  <div class="info">Enter a valid FTC event code to view the match details</div>
  <input id="event-code-input" type="text" placeholder="Enter event code" />
  <button id="submit-event-code">Submit</button>

  <div id="warning-box" class="warning-box" style="display: none;"></div>
  <div id="prediction-box" class="prediction-box" style="display: none;"></div>

  <div id="matches"></div>

  <script>
    const eventCodeInput = document.getElementById("event-code-input");
    const submitButton = document.getElementById("submit-event-code");
    const warningBox = document.getElementById("warning-box");
    const predictionBox = document.getElementById("prediction-box");
    const matchesContainer = document.getElementById("matches");

    let highlightedTeam = null; // Store the highlighted team for prediction

    submitButton.addEventListener("click", async () => {
      const eventCode = eventCodeInput.value;
      if (!eventCode) {
        alert("Please enter an event code.");
        return;
      }
      try {
        const matchesResponse = await fetch(`https://api.ftcscout.org/rest/v1/events/2024/${eventCode}/matches`);
        const matchesData = await matchesResponse.json();

        let teamsWithoutOPR = 0;
        let teamsData = [];

        // Clear previous results
        matchesContainer.innerHTML = "";

        for (const match of matchesData) {
          const matchNumber = match.id;
          const matchElement = document.createElement("div");
          matchElement.classList.add("match");

          const matchTitle = document.createElement("h3");
          matchTitle.textContent = `Match ${matchNumber}`;
          matchElement.appendChild(matchTitle);

          const matchTable = document.createElement("table");
          matchTable.classList.add("team-table");
          const tableHeader = document.createElement("thead");
          const headerRow = document.createElement("tr");
          headerRow.innerHTML = "<th>Team</th><th>OPR</th>";
          tableHeader.appendChild(headerRow);
          matchTable.appendChild(tableHeader);

          const tableBody = document.createElement("tbody");

          for (const teamData of match.teams) {
            const teamNumber = teamData.teamNumber;
            const teamNameResponse = await fetch(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}`);
            const teamNameData = await teamNameResponse.json();
            const teamName = teamNameData.name;

            const oprResponse = await fetch(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}/quick-stats?season=2024`);
            const oprData = await oprResponse.json();
            const opr = oprData.tot ? oprData.tot.value : null;

            if (!opr) {
              teamsWithoutOPR++;
              teamName += " *";
            } else {
              opr = Math.round(opr);  // Round OPR to the nearest whole number
            }

            const teamRow = document.createElement("tr");
            const teamCell = document.createElement("td");
            teamCell.textContent = teamName;
            const oprCell = document.createElement("td");
            oprCell.textContent = opr ? opr : "N/A";

            teamRow.appendChild(teamCell);
            teamRow.appendChild(oprCell);
            tableBody.appendChild(teamRow);

            // Store team data for prediction box (highlighted team)
            if (highlightedTeam === null) {
              highlightedTeam = {
                number: teamNumber,
                name: teamName,
                opr: opr ? opr : "N/A"
              };
            }
          }

          matchTable.appendChild(tableBody);
          matchElement.appendChild(matchTable);
          matchesContainer.appendChild(matchElement);
        }

        // Update warning box
        if (teamsWithoutOPR > 0) {
          warningBox.style.display = "block";
          warningBox.textContent = `${teamsWithoutOPR} team${teamsWithoutOPR > 1 ? "s" : ""} in this event have no data (shown by *)`;
        } else {
          warningBox.style.display = "none";
        }

        // Prediction Box with dynamically highlighted team
        if (highlightedTeam) {
          predictionBox.style.display = "block";
          predictionBox.innerHTML = `
            Team ${highlightedTeam.number} - ${highlightedTeam.name} is predicted to have a W-L-T record of 5-2-3 at this event.
          `;
        }

      } catch (error) {
        console.error("Error fetching data:", error);
        alert("There was an error fetching the data. Please try again.");
      }
    });

  </script>
</body>
</html>
