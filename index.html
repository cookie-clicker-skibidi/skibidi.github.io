<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Match Scouting</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <style>
    :root { font-family: 'Inter', sans-serif; }
    body {
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 { font-size: 30px; margin-top: 20px; }
    .info { margin: 5px 0 15px; font-size: 16px; color: #ccc; }
    .input-container { margin: 20px 0; }
    input, button {
      padding: 10px;
      margin: 5px;
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 5px;
      text-align: center;
    }
    .team-box {
      background-color: #2c2c2c;
      margin: 15px auto;
      padding: 10px;
      border-radius: 10px;
      width: 60%;
    }
    .gray-box {
      background-color: #3a3a3a;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      margin: 15px auto;
      width: 60%;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>FTC Match Scouting</h1>
  <div class="input-container">
    <input type="text" id="eventCode" placeholder="Enter Event Code (e.g. USMIFRQ2)">
    <input type="number" id="highlightTeam" placeholder="Team # to highlight">
    <button onclick="loadMatchData()">Load Matches</button>
  </div>
  <div id="summary"></div>
  <div id="matches"></div>
  <script>
    async function fetchJSON(url) {
      const res = await fetch(url);
      return res.json();
    }

    function calcRP(wins, losses, ties) {
      const totalMatches = wins + losses + ties;
      return totalMatches ? ((2 * wins + ties) / totalMatches).toFixed(2) : "0.00";
    }

    function ordinal(n) {
      const s = ["th", "st", "nd", "rd"], v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    async function loadMatchData() {
      const code = document.getElementById("eventCode").value.trim();
      const highlightTeam = parseInt(document.getElementById("highlightTeam").value.trim()) || null;
      document.getElementById("matches").innerHTML = "Loading...";
      const matchData = await fetchJSON(`https://api.ftcscout.org/rest/v1/events/2024/${code}/matches`);

      const teamStats = {};
      const matchDisplay = [];

      for (const match of matchData) {
        if (!match.scores && match.teams?.length === 4) {
          const red = match.teams.filter(t => t.alliance === 'Red');
          const blue = match.teams.filter(t => t.alliance === 'Blue');
          const redOPR = await avgTeamOPR(red);
          const blueOPR = await avgTeamOPR(blue);

          let redScore = Math.round(redOPR);
          let blueScore = Math.round(blueOPR);

          const predictedWinner = redScore > blueScore ? red : blue;
          const team1 = predictedWinner[0].teamNumber;
          const team2 = predictedWinner[1].teamNumber;

          // Update W/L/T
          [red, blue].forEach((alliance, i) => {
            const win = i === (redScore > blueScore ? 0 : redScore < blueScore ? 1 : -1);
            alliance.forEach(t => {
              const tn = t.teamNumber;
              if (!teamStats[tn]) teamStats[tn] = { wins: 0, losses: 0, ties: 0, name: "", opr: 0 };
              if (win === -1) teamStats[tn].ties++;
              else win ? teamStats[tn].wins++ : teamStats[tn].losses++;
            });
          });

          matchDisplay.push(`<div class="team-box">
            <div>Match #${match.id}</div>
            <div style="color:#f44336">Red: ${red.map(t => t.teamNumber).join(" & ")} — ${redScore}</div>
            <div style="color:#2196f3">Blue: ${blue.map(t => t.teamNumber).join(" & ")} — ${blueScore}</div>
          </div>`);
        }
      }

      const teamsRanked = Object.entries(teamStats).map(([tn, stats]) => {
        return {
          teamNumber: tn,
          ...stats,
          RP: parseFloat(calcRP(stats.wins, stats.losses, stats.ties))
        };
      }).sort((a, b) => b.RP - a.RP);

      const top = teamsRanked[0];
      const highlight = highlightTeam ? teamsRanked.findIndex(t => t.teamNumber == highlightTeam) : -1;
      const highlightEntry = highlight >= 0 ? teamsRanked[highlight] : null;

      let summaryHTML = `
        <div class="gray-box">Predicted 1st Place: Team ${top.teamNumber} (W-L-T: ${top.wins}-${top.losses}-${top.ties}, RP: ${top.RP})</div>
      `;
      if (highlightEntry) {
        summaryHTML += `<div class="gray-box">Team ${highlightEntry.teamNumber} is predicted to be in ${ordinal(highlight + 1)} (W-L-T: ${highlightEntry.wins}-${highlightEntry.losses}-${highlightEntry.ties}, RP: ${highlightEntry.RP})</div>`;
      }

      document.getElementById("summary").innerHTML = summaryHTML;
      document.getElementById("matches").innerHTML = matchDisplay.join("");
    }

    async function avgTeamOPR(teams) {
      const values = await Promise.all(teams.map(async t => {
        const res = await fetchJSON(`https://api.ftcscout.org/rest/v1/teams/${t.teamNumber}/quick-stats?season=2024`);
        return res.tot?.value || 0;
      }));
      return values.reduce((a, b) => a + b, 0);
    }
  </script>
</body>
</html>
