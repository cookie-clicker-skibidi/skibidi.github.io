<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Match OPR Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .info {
      font-size: 16px;
      color: #bbb;
      margin-bottom: 20px;
    }
    .input-container {
      margin-bottom: 20px;
    }
    input {
      padding: 10px;
      width: 220px;
      background-color: #1e1e1e;
      border: 1px solid #444;
      color: white;
      border-radius: 5px;
      text-align: center;
    }
    button {
      padding: 10px 15px;
      margin-left: 5px;
      background-color: #6200ee;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3700b3;
    }
    .team-box {
      background-color: #333;
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .warning-box {
      background-color: #f1c40f;
      color: #333;
      padding: 10px;
      margin: 15px 0;
      border-radius: 5px;
      font-size: 16px;
    }
    .prediction-box {
      background-color: #555;
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .rounded {
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Enter Event Code</h1>
  <div class="info">Enter a valid FTC event code and select a team to view the predicted record</div>
  
  <!-- Input containers for Event code and Team selection -->
  <div class="input-container">
    <input id="event-code-input" type="text" placeholder="Enter event code" />
    <button id="submit-event-code">Submit Event Code</button>
  </div>
  
  <div class="input-container">
    <input id="highlight-team-input" type="number" placeholder="Enter team number" />
    <button id="submit-highlight-team">Highlight Team</button>
  </div>

  <!-- Warning and prediction boxes -->
  <div id="warning-box" class="warning-box" style="display: none;"></div>
  <div id="prediction-box" class="prediction-box" style="display: none;"></div>

  <!-- Matches will be displayed here -->
  <div id="matches"></div>

  <script>
    const eventCodeInput = document.getElementById("event-code-input");
    const highlightTeamInput = document.getElementById("highlight-team-input");
    const submitEventCodeButton = document.getElementById("submit-event-code");
    const submitHighlightTeamButton = document.getElementById("submit-highlight-team");
    const warningBox = document.getElementById("warning-box");
    const predictionBox = document.getElementById("prediction-box");
    const matchesContainer = document.getElementById("matches");

    let eventCode = '';
    let highlightedTeam = null;  // To store highlighted team
    let teamsWithoutOPR = 0;

    // Function to fetch teams' OPRs and data
    async function getTeamData(teamNumber) {
      try {
        const teamNameResponse = await fetch(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}`);
        const teamNameData = await teamNameResponse.json();
        const teamName = teamNameData.name;

        const oprResponse = await fetch(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}/quick-stats?season=2024`);
        const oprData = await oprResponse.json();
        let opr = oprData.tot ? oprData.tot.value : null;

        if (!opr) {
          opr = "N/A";  // Mark as N/A if no OPR
        } else {
          opr = Math.round(opr); // Round OPR to the nearest whole number
        }

        return { teamName, opr };
      } catch (error) {
        console.error("Error fetching team data:", error);
        return { teamName: "Unknown", opr: "N/A" };
      }
    }

    // Event listener for submitting event code
    submitEventCodeButton.addEventListener("click", async () => {
      eventCode = eventCodeInput.value.trim();
      if (!eventCode) {
        alert("Please enter an event code.");
        return;
      }
      await loadMatches();
    });

    // Event listener for highlighting a team
    submitHighlightTeamButton.addEventListener("click", () => {
      const teamNumber = parseInt(highlightTeamInput.value.trim());
      if (!teamNumber) {
        alert("Please enter a valid team number.");
        return;
      }
      highlightedTeam = { teamNumber };  // Store highlighted team
      displayPredictionBox(); // Display prediction for this team
    });

    // Function to load matches for the event
    async function loadMatches() {
      try {
        const matchesResponse = await fetch(`https://api.ftcscout.org/rest/v1/events/2024/${eventCode}/matches`);
        const matchesData = await matchesResponse.json();

        teamsWithoutOPR = 0; // Reset counter for teams without OPR
        matchesContainer.innerHTML = ''; // Clear previous matches

        // Loop through each match and display the teams
        for (const match of matchesData) {
          const matchNumber = match.id;
          const matchElement = document.createElement("div");
          matchElement.classList.add("match");

          const matchTitle = document.createElement("h3");
          matchTitle.textContent = `Match ${matchNumber}`;
          matchElement.appendChild(matchTitle);

          const matchTable = document.createElement("table");
          matchTable.classList.add("team-table");
          const tableHeader = document.createElement("thead");
          const headerRow = document.createElement("tr");
          headerRow.innerHTML = "<th>Team</th><th>OPR</th>";
          tableHeader.appendChild(headerRow);
          matchTable.appendChild(tableHeader);

          const tableBody = document.createElement("tbody");

          for (const teamData of match.teams) {
            const teamNumber = teamData.teamNumber;
            const { teamName, opr } = await getTeamData(teamNumber);

            // Increment counter if team has no OPR data
            if (opr === "N/A") {
              teamsWithoutOPR++;
              teamName += " *";  // Add asterisk for teams with no OPR
            }

            const teamRow = document.createElement("tr");
            const teamCell = document.createElement("td");
            teamCell.textContent = teamName;
            const oprCell = document.createElement("td");
            oprCell.textContent = opr;

            teamRow.appendChild(teamCell);
            teamRow.appendChild(oprCell);
            tableBody.appendChild(teamRow);
          }

          matchTable.appendChild(tableBody);
          matchElement.appendChild(matchTable);
          matchesContainer.appendChild(matchElement);
        }

        // Update warning box for teams without OPR
        if (teamsWithoutOPR > 0) {
          warningBox.style.display = "block";
          warningBox.textContent = `${teamsWithoutOPR} team${teamsWithoutOPR > 1 ? "s" : ""} in this event have no data (shown by *)`;
        } else {
          warningBox.style.display = "none";
        }

      } catch (error) {
        console.error("Error fetching matches:", error);
        alert("There was an error fetching match data.");
      }
    }

    // Function to display prediction box for highlighted team
    function displayPredictionBox() {
      if (!highlightedTeam) return;
      predictionBox.style.display = "block";
      predictionBox.innerHTML = `
        Team ${highlightedTeam.teamNumber} is predicted to have a W-L-T record of 5-2-3 at this event.
      `;
    }
  </script>
</body>
</html>
